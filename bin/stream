#!/bin/sh -eu

# OBS! Variables in capital letters are delivered via systemd

# Get Pulseaudio input number (ffmpeg bugs with symbolic name)
input_num="$(pactl -f json list sources short|jq -e 'map(select(.name == env.INPUT) | .index)[0]')"

case "${FORMAT-}" in
    opus)
	ffmpeg -nostdin -f pulse -i "$input_num" -c:a libopus -vbr on -b:a "$BITRATE" -content_type audio/ogg -vn -f opus "$OUTPUT"
	;;
    mp3)
	ffmpeg -nostdin -f pulse -i "$input_num" -c:a libmp3lame -qscale:a "$QUALITY" -content_type audio/mpeg -vn -f mp3 "$OUTPUT"
	;;
    *)
	echo "Unknown codec" >&2
	;;
esac
